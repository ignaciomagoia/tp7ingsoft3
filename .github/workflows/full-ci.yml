name: Full CI

# Ejecutar en pushes/PRs hacia main y permitir dispararlo manualmente.
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# SonarCloud solo necesita permisos de lectura para PR decoration.
permissions:
  contents: read
  pull-requests: read

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
      # Obtener el código del backend.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Configurar Go tomando la versión del go.mod.
      - name: Setup Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version-file: backend/go.mod

      # Ejecutar los tests de Go y generar coverage.out en backend/.
      - name: Run backend unit tests
        working-directory: backend
        run: go test ./... -coverprofile=coverage.out

      # Publicar el coverage para que lo consuma SonarCloud.
      - name: Upload backend coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.out
          if-no-files-found: error

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      # Obtener el código del frontend.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Instalar Node.js 22.x y cachear npm para acelerar el pipeline.
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # Instalar dependencias de React.
      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      # Ejecutar Jest con coverage para generar frontend/coverage/lcov.info.
      - name: Run frontend unit tests
        working-directory: frontend
        env:
          CI: true
        run: npm test -- --coverage --watchAll=false

      # Publicar el reporte de coverage del frontend.
      - name: Upload frontend coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: frontend/coverage/lcov.info
          if-no-files-found: error

  sonarcloud-analysis:
    name: SonarCloud Analysis
    needs:
      - backend-tests
      - frontend-tests
    runs-on: ubuntu-latest
    # Solo corremos el análisis cuando tenemos referencia clara a main o PR contra main.
    if: >
      github.ref == 'refs/heads/main' ||
      github.event_name == 'pull_request'
    steps:
      # Checkout completo para que Sonar tenga historial y blame.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Recuperar los artifacts de coverage generados en los jobs previos.
      - name: Download backend coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend

      - name: Download frontend coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-report
          path: frontend/coverage

      # Ejecutar SonarCloud indicando explícitamente la carpeta base y la rama.
      - name: Run SonarCloud scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: ${{ github.workspace }}
          args: >
            -Dsonar.branch.name=${{ github.ref_name }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Esperar al Quality Gate para bloquear el pipeline si falla.
      - name: Enforce SonarCloud Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        timeout-minutes: 15

  summary:
    name: CI Summary
    needs: sonarcloud-analysis
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      # Mensaje final para dejar claro que todo pasó.
      - name: Show success summary
        run: echo "✅ Tests completados y Quality Gate aprobado en SonarCloud."
